<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœç´¢ç»“æœ - æ±é‚‘éŸ³éŸµ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">æ±é‚‘éŸ³éŸµ</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">é¦–é¡µ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">å…³äº</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- å†…å®¹åŒºåŸŸ -->
    <div class="container mt-4">
        <!-- æœç´¢æ¡† -->
        <div class="row mb-4">
            <div class="col-md-6 mx-auto">
                <form id="searchForm">
                    <div class="input-group">
                        <input type="text" id="characterInput" class="form-control" placeholder="æœç´¢æ±‰å­—" required>
                        <button class="btn btn-primary" type="submit">æœç´¢</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- æœç´¢ç»“æœ -->
        <div class="row">
            <div class="col-12">
                <div id="searchInfo" class="d-flex justify-content-between align-items-center mb-4" style="display: none !important;">
                    <div class="text-muted">æŸ¥è¯¢ï¼š<span class="text-primary fw-bold" id="searchCharacter"></span></div>
                    <span class="badge bg-primary" id="resultCount">0 ä¸ª</span>
                </div>

                <!-- è¡¨æ ¼ - ä¿æŒç°æœ‰å®½åº¦ï¼Œåˆ—å®½æ¯”ä¾‹1:1:2 -->
                <div id="resultsTable" class="card" style="max-width: 800px; margin: 0 auto; display: none;">
                    <div class="card-body p-0">
                        <table class="table mb-0" style="table-layout: fixed;">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 25%">æ±‰å­—</th>
                                    <th style="width: 25%">éŸ³æ ‡</th>
                                    <th style="width: 50%">æ³¨é‡Š</th>
                                </tr>
                            </thead>
                            <tbody id="resultsBody">
                                <!-- ç»“æœå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- æ— ç»“æœ -->
                <div id="noResults" class="text-center py-5" style="display: none;">
                    <p class="text-muted mb-4" id="noResultsText">æœªæ‰¾åˆ°å‘éŸ³æ•°æ®</p>
                </div>
            </div>
        </div>
    </div>

    <!-- éŸ³é¢‘æ’­æ”¾å™¨ -->
    <audio id="audioPlayer" preload="none"></audio>

    <!-- é¡µè„š -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container text-center">
            <p>&copy; 2024 æ±é‚‘éŸ³éŸµ - æ±åŸè¯å‘éŸ³è¯å…¸</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <style>
    .table {
        width: 100%;
        margin-bottom: 0;
    }

    .table th {
        font-weight: 500;
        padding: 0.75rem;
        border-bottom: 2px solid #dee2e6;
        text-align: center;
    }

    .table td {
        padding: 1rem;
        border-color: #f1f3f4;
        text-align: center;
        word-wrap: break-word;
    }

    .phonetic-clickable {
        cursor: pointer;
        color: #0d6efd;
        font-weight: 500;
        padding: 4px 8px;
        border-radius: 4px;
        display: inline-flex;
        align-items: center;
        margin: 2px 0;
        font-family: 'Arial Unicode MS', 'Lucida Sans Unicode', sans-serif;
        transition: background-color 0.2s;
    }

    .phonetic-clickable:hover {
        background-color: #f8f9fa;
    }

    .audio-icon {
        margin-left: 4px;
        opacity: 0.7;
        font-size: 0.8em;
    }

    /* ç§»é™¤è¡¨æ ¼è¡Œçš„æ‚¬åœæ•ˆæœ */
    .table-hover tbody tr:hover {
        background-color: transparent;
    }
    </style>

    <script>
    // å…¨å±€æ’­æ”¾éŸ³é¢‘å‡½æ•°
    async function playAudio(phonetic) {
        console.log('ç‚¹å‡»éŸ³æ ‡:', phonetic);

        try {
            // æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            const audioExists = await window.app.checkAudioExists(phonetic);
            console.log('æ£€æŸ¥ç»“æœ:', audioExists);

            if (audioExists.exists) {
                const audioPlayer = document.getElementById('audioPlayer');
                const audioUrl = `static/audio/${audioExists.filename}`;
                console.log('éŸ³é¢‘URL:', audioUrl);

                // è®¾ç½®éŸ³é¢‘æºå¹¶æ’­æ”¾
                audioPlayer.src = audioUrl;

                // ä½¿ç”¨Promiseå¤„ç†æ’­æ”¾
                const playPromise = audioPlayer.play();

                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        console.log('éŸ³é¢‘å¼€å§‹æ’­æ”¾');
                    }).catch(error => {
                        console.error('æ’­æ”¾å¤±è´¥:', error);
                    });
                }

            } else {
                // éŸ³é¢‘æ–‡ä»¶ä¸å­˜åœ¨ï¼Œé™é»˜å¤±è´¥
                console.log('éŸ³é¢‘æ–‡ä»¶ä¸å­˜åœ¨:', phonetic);
            }
        } catch (error) {
            // æ’­æ”¾å‡ºé”™ï¼Œé™é»˜å¤±è´¥
            console.error('æ’­æ”¾éŸ³é¢‘æ—¶å‡ºé”™:', error);
        }
    }

    // æ˜¾ç¤ºæœç´¢ç»“æœ
    function displayResults(character, results) {
        const searchInfo = document.getElementById('searchInfo');
        const resultsTable = document.getElementById('resultsTable');
        const noResults = document.getElementById('noResults');
        const searchCharacter = document.getElementById('searchCharacter');
        const resultCount = document.getElementById('resultCount');
        const resultsBody = document.getElementById('resultsBody');
        const noResultsText = document.getElementById('noResultsText');

        // æ›´æ–°æœç´¢ä¿¡æ¯
        searchCharacter.textContent = character;

        if (Object.keys(results).length === 0) {
            // æ— ç»“æœ
            searchInfo.style.display = 'none';
            resultsTable.style.display = 'none';
            noResults.style.display = 'block';
            noResultsText.textContent = `æœªæ‰¾åˆ°"${character}"çš„å‘éŸ³æ•°æ®`;
        } else {
            // æœ‰ç»“æœ
            searchInfo.style.display = 'flex';
            resultsTable.style.display = 'block';
            noResults.style.display = 'none';
            resultCount.textContent = `${Object.keys(results).length} ä¸ª`;

            // æ¸…ç©ºè¡¨æ ¼å†…å®¹
            resultsBody.innerHTML = '';

            // ç”Ÿæˆç»“æœè¡Œ
            for (const [word, pronunciations] of Object.entries(results)) {
                const pronunciationsArray = Array.isArray(pronunciations) ? pronunciations : [pronunciations];

                pronunciationsArray.forEach((pron, index) => {
                    const row = document.createElement('tr');

                    // ç¬¬ä¸€è¡Œæ˜¾ç¤ºæ±‰å­—ï¼ˆè·¨è¡Œï¼‰
                    if (index === 0) {
                        const charCell = document.createElement('td');
                        charCell.className = 'align-middle';
                        charCell.rowSpan = pronunciationsArray.length;
                        charCell.innerHTML = `<div class="fs-3 fw-bold text-dark text-center">${word}</div>`;
                        row.appendChild(charCell);
                    }

                    // éŸ³æ ‡å•å…ƒæ ¼
                    const phoneticCell = document.createElement('td');
                    phoneticCell.className = 'align-middle text-center';

                    if (pron.phonetic) {
                        const phonetics = pron.phonetic.split(',');
                        phoneticCell.innerHTML = phonetics.map((ph, phIndex) => {
                            const phoneticClean = ph.trim();
                            return `
                                <span class="phonetic-clickable"
                                      data-phonetic="${phoneticClean}"
                                      onclick="playAudio('${phoneticClean}')">
                                    [${phoneticClean}]
                                    <small class="audio-icon">ğŸ”Š</small>
                                </span>
                                ${phIndex < phonetics.length - 1 ? '<br>' : ''}
                            `;
                        }).join('');
                    } else if (pron.pronunciation) {
                        const phoneticClean = pron.pronunciation.trim();
                        phoneticCell.innerHTML = `
                            <span class="phonetic-clickable"
                                  data-phonetic="${phoneticClean}"
                                  onclick="playAudio('${phoneticClean}')">
                                [${phoneticClean}]
                                <small class="audio-icon">ğŸ”Š</small>
                            </span>
                        `;
                    } else {
                        phoneticCell.innerHTML = '<span class="text-muted">-</span>';
                    }
                    row.appendChild(phoneticCell);

                    // æ³¨é‡Šå•å…ƒæ ¼
                    const notesCell = document.createElement('td');
                    notesCell.className = 'align-middle text-muted text-center';
                    notesCell.textContent = pron.notes ? pron.notes : '-';
                    row.appendChild(notesCell);

                    resultsBody.appendChild(row);
                });
            }
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œæœç´¢
    document.addEventListener('DOMContentLoaded', function() {
        console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–æœç´¢ç»“æœé¡µé¢');

        // è®¾ç½®æœç´¢è¡¨å•æäº¤äº‹ä»¶
        document.getElementById('searchForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const characterInput = document.getElementById('characterInput');
            const character = characterInput.value.trim();

            if (!character) {
                alert('è¯·è¾“å…¥è¦æœç´¢çš„æ±‰å­—');
                return;
            }

            // æ‰§è¡Œæœç´¢
            performSearch(character);
        });

        // ä»URLå‚æ•°è·å–æœç´¢è¯
        const urlParams = new URLSearchParams(window.location.search);
        const character = urlParams.get('character');

        if (character) {
            document.getElementById('characterInput').value = character;
            performSearch(character);
        }
    });

    // æ‰§è¡Œæœç´¢
    function performSearch(character) {
        if (!window.app || !window.app.data) {
            console.error('æ•°æ®å°šæœªåŠ è½½å®Œæˆ');
            return;
        }

        const results = window.app.searchCharacters(character);
        displayResults(character, results);
    }
    </script>
</body>
</html>