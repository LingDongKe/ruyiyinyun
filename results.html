<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœç´¢ç»“æœ - æ±é‚‘éŸ³éŸµ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">æ±é‚‘éŸ³éŸµ</a>
            <div class="navbar-nav flex-row ms-auto">
                <a class="nav-link mx-3" href="index.html">é¦–é¡µ</a>
                <a class="nav-link mx-3" href="about.html">å…³äº</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- æœç´¢æ¡† -->
        <div class="row mb-4">
            <div class="col-md-6 mx-auto">
                <form id="searchForm">
                    <div class="input-group">
                        <input type="text" name="character" id="characterInput" class="form-control" placeholder="æœç´¢æ±‰å­—" required>
                        <button class="btn btn-primary" type="submit">æœç´¢</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- æœç´¢ç»“æœ -->
        <div class="row">
            <div class="col-12">
                <!-- æœç´¢ä¿¡æ¯åŒºåŸŸ -->
                <div id="searchInfo" class="d-flex justify-content-between align-items-center mb-4" style="display: none !important;">
                    <div class="text-muted">æŸ¥è¯¢ï¼š<span class="text-primary fw-bold" id="searchCharacter"></span></div>
                    <span class="badge bg-primary" id="resultCount">0 ä¸ª</span>
                </div>

                <!-- ç»“æœè¡¨æ ¼ -->
                <div id="resultsTable" class="card" style="max-width: 800px; margin: 0 auto; display: none;">
                    <div class="card-body p-0">
                        <table class="table mb-0" style="table-layout: fixed;">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 25%">æ±‰å­—</th>
                                    <th style="width: 25%">éŸ³æ ‡</th>
                                    <th style="width: 50%">æ³¨é‡Š</th>
                                </tr>
                            </thead>
                            <tbody id="resultsBody">
                                <!-- ç»“æœå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                        <!-- éŸ³é¢‘çŠ¶æ€æç¤º -->
                        <div id="audioStatus" class="text-center py-2" style="display: none;">
                            <span id="audioStatusText"></span>
                        </div>
                    </div>
                </div>

                <!-- æ— ç»“æœ -->
                <div id="noResults" class="text-center py-5" style="display: none;">
                    <p class="text-muted mb-4" id="noResultsText">æœªæ‰¾åˆ°å­—éŸ³æ•°æ®</p>
                </div>
            </div>
        </div>
    </div>

    <!-- éŸ³é¢‘æ’­æ”¾å™¨ -->
    <audio id="audioPlayer" preload="none"></audio>

    <!-- é¡µè„š -->
    <footer class="bg-dark text-white py-3 mt-auto">
        <div class="container h-100 d-flex justify-content-center align-items-center">
            <p class="mb-0">&copy; 2025 æ±é‚‘éŸ³éŸµ - æ±åŸè¯å­—éŸ³æŸ¥è¯¢å™¨</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script src="js/search.js"></script>
    <style>
    .table {
        width: 100%;
        margin-bottom: 0;
    }

    .table th {
        font-weight: 500;
        padding: 0.75rem;
        border-bottom: 2px solid #dee2e6;
        text-align: center;
    }

    .table td {
        padding: 1rem;
        border-color: #f1f3f4;
        text-align: center;
        word-wrap: break-word;
    }

    .phonetic-clickable {
        cursor: pointer;
        color: #0d6efd;
        font-weight: 500;
        padding: 4px 8px;
        border-radius: 4px;
        display: inline-flex;
        align-items: center;
        margin: 2px 0;
        font-family: 'Arial Unicode MS', 'Lucida Sans Unicode', sans-serif;
        transition: background-color 0.2s;
    }

    .phonetic-clickable:hover {
        background-color: #f8f9fa;
    }

    .audio-icon {
        margin-left: 4px;
        opacity: 0.7;
        font-size: 0.8em;
    }

    /* éŸ³é¢‘çŠ¶æ€æç¤ºæ ·å¼ */
    #audioStatus {
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
        transition: all 0.3s ease;
    }

    .status-loading {
        color: #0d6efd;
    }

    .status-missing {
        color: #dc3545;
    }

    /* ç§»é™¤è¡¨æ ¼è¡Œçš„æ‚¬åœæ•ˆæœ */
    .table-hover tbody tr:hover {
        background-color: transparent;
    }

    /* åŠ è½½çŠ¶æ€ä¸‹çš„éŸ³æ ‡æ ·å¼ */
    .phonetic-loading {
        opacity: 0.6;
        pointer-events: none;
    }
    </style>

    <script>
    // éŸ³é¢‘æ’­æ”¾çŠ¶æ€
    let isAudioLoading = false;

    // æ˜¾ç¤ºéŸ³é¢‘çŠ¶æ€æç¤º
    function showAudioStatus(message, type) {
        const audioStatus = document.getElementById('audioStatus');
        const audioStatusText = document.getElementById('audioStatusText');

        if (audioStatus && audioStatusText) {
            // ç§»é™¤ä¹‹å‰çš„æ ·å¼ç±»
            audioStatusText.className = '';
            // æ·»åŠ æ–°çš„æ ·å¼ç±»
            audioStatusText.classList.add(`status-${type}`);

            // è®¾ç½®æ¶ˆæ¯å†…å®¹
            audioStatusText.innerHTML = message;

            // æ˜¾ç¤ºçŠ¶æ€åŒºåŸŸ
            audioStatus.style.display = 'block';

            // æ·¡å…¥æ•ˆæœ
            setTimeout(() => {
                audioStatus.style.opacity = '1';
            }, 10);
        }
    }

    // éšè—éŸ³é¢‘çŠ¶æ€æç¤º
    function hideAudioStatus() {
        const audioStatus = document.getElementById('audioStatus');
        if (audioStatus) {
            // æ·¡å‡ºæ•ˆæœ
            audioStatus.style.opacity = '0';
            setTimeout(() => {
                audioStatus.style.display = 'none';
            }, 300);
        }
    }

    // å…¨å±€æ’­æ”¾éŸ³é¢‘å‡½æ•°
    async function playAudio(phonetic) {
        console.log('ç‚¹å‡»éŸ³æ ‡:', phonetic);

        // å¦‚æœæ­£åœ¨åŠ è½½ï¼Œä¸é‡å¤ç‚¹å‡»
        if (isAudioLoading) {
            console.log('éŸ³é¢‘æ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...');
            return;
        }

        try {
            // æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            const audioExists = await window.app.checkAudioExists(phonetic);
            console.log('æ£€æŸ¥ç»“æœ:', audioExists);

            if (audioExists.exists) {
                // æœ‰éŸ³é¢‘æ–‡ä»¶ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
                isAudioLoading = true;
                showAudioStatus('<div class="spinner-border spinner-border-sm me-2" role="status"><span class="visually-hidden">åŠ è½½ä¸­...</span></div>éŸ³é¢‘åŠ è½½ä¸­...', 'loading');

                // ç¦ç”¨æ‰€æœ‰éŸ³æ ‡ç‚¹å‡»
                document.querySelectorAll('.phonetic-clickable').forEach(element => {
                    element.classList.add('phonetic-loading');
                });

                const audioPlayer = document.getElementById('audioPlayer');
                const audioUrl = `static/audio/${audioExists.filename}`;
                console.log('éŸ³é¢‘URL:', audioUrl);

                // è®¾ç½®éŸ³é¢‘æº
                audioPlayer.src = audioUrl;

                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                audioPlayer.oncanplaythrough = function() {
                    console.log('éŸ³é¢‘å¯ä»¥æ’­æ”¾');
                };

                audioPlayer.onplaying = function() {
                    console.log('éŸ³é¢‘å¼€å§‹æ’­æ”¾');
                    hideAudioStatus();
                    resetAudioState();
                };

                audioPlayer.onended = function() {
                    console.log('éŸ³é¢‘æ’­æ”¾ç»“æŸ');
                    resetAudioState();
                };

                // ä½¿ç”¨Promiseå¤„ç†æ’­æ”¾
                const playPromise = audioPlayer.play();

                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        console.log('éŸ³é¢‘å¼€å§‹æ’­æ”¾');
                        // æ’­æ”¾æˆåŠŸï¼ŒçŠ¶æ€åœ¨onplayingäº‹ä»¶ä¸­å¤„ç†
                    }).catch(error => {
                        console.error('æ’­æ”¾å¤±è´¥:', error);
                        // é™é»˜å¤±è´¥ï¼Œä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                        hideAudioStatus();
                        resetAudioState();
                    });
                }

            } else {
                // éŸ³é¢‘æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç›´æ¥æ˜¾ç¤ºç¼ºå¤±çŠ¶æ€
                console.log('éŸ³é¢‘æ–‡ä»¶ä¸å­˜åœ¨:', phonetic);
                showAudioStatus('âŒ éŸ³é¢‘ç¼ºå¤±', 'missing');
                setTimeout(hideAudioStatus, 2000);
            }
        } catch (error) {
            // æ’­æ”¾å‡ºé”™ï¼Œé™é»˜å¤±è´¥
            console.error('æ’­æ”¾éŸ³é¢‘æ—¶å‡ºé”™:', error);
            hideAudioStatus();
            resetAudioState();
        }
    }

    // é‡ç½®éŸ³é¢‘çŠ¶æ€
    function resetAudioState() {
        isAudioLoading = false;

        // æ¢å¤æ‰€æœ‰éŸ³æ ‡ç‚¹å‡»
        document.querySelectorAll('.phonetic-clickable').forEach(element => {
            element.classList.remove('phonetic-loading');
        });
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œæœç´¢
    document.addEventListener('DOMContentLoaded', function() {
        console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–æœç´¢ç»“æœé¡µé¢');

        // ä»URLå‚æ•°è·å–æœç´¢è¯
        const urlParams = new URLSearchParams(window.location.search);
        const character = urlParams.get('character');

        if (character) {
            document.getElementById('characterInput').value = character;
        }

        // ç­‰å¾…æ•°æ®åŠ è½½å®Œæˆåæ‰§è¡Œæœç´¢
        function waitForDataAndSearch() {
            if (window.app && window.app.dataLoaded) {
                console.log('æ•°æ®å·²åŠ è½½ï¼Œæ‰§è¡Œæœç´¢:', character);
                if (character) {
                    performSearch(character);
                }
            } else {
                // æ•°æ®æœªåŠ è½½å®Œæˆï¼Œç­‰å¾…100msåé‡è¯•
                setTimeout(waitForDataAndSearch, 100);
            }
        }

        // å¼€å§‹ç­‰å¾…æ•°æ®å¹¶æ‰§è¡Œæœç´¢
        waitForDataAndSearch();
    });

    // æ‰§è¡Œæœç´¢
    function performSearch(character) {
        if (!window.app || !window.app.data) {
            console.error('æ•°æ®å°šæœªåŠ è½½å®Œæˆ');
            return;
        }

        const results = window.app.searchCharacters(character);
        displayResults(character, results);
    }

    // æ˜¾ç¤ºæœç´¢ç»“æœ
    function displayResults(character, results) {
        const searchInfo = document.getElementById('searchInfo');
        const resultsTable = document.getElementById('resultsTable');
        const noResults = document.getElementById('noResults');
        const searchCharacter = document.getElementById('searchCharacter');
        const resultCount = document.getElementById('resultCount');
        const resultsBody = document.getElementById('resultsBody');
        const noResultsText = document.getElementById('noResultsText');

        // æ›´æ–°æœç´¢ä¿¡æ¯
        searchCharacter.textContent = character;

        if (Object.keys(results).length === 0) {
            // æ— ç»“æœ
            searchInfo.style.display = 'none';
            resultsTable.style.display = 'none';
            noResults.style.display = 'block';
            noResultsText.textContent = `æœªæ‰¾åˆ°"${character}"çš„å­—éŸ³æ•°æ®`;
        } else {
            // æœ‰ç»“æœ
            searchInfo.style.display = 'flex';
            resultsTable.style.display = 'block';
            noResults.style.display = 'none';
            resultCount.textContent = `${Object.keys(results).length} ä¸ª`;

            // æ¸…ç©ºè¡¨æ ¼å†…å®¹
            resultsBody.innerHTML = '';

            // ç”Ÿæˆç»“æœè¡Œ
            for (const [word, pronunciations] of Object.entries(results)) {
                const pronunciationsArray = Array.isArray(pronunciations) ? pronunciations : [pronunciations];

                pronunciationsArray.forEach((pron, index) => {
                    const row = document.createElement('tr');

                    // ç¬¬ä¸€è¡Œæ˜¾ç¤ºæ±‰å­—ï¼ˆè·¨è¡Œï¼‰
                    if (index === 0) {
                        const charCell = document.createElement('td');
                        charCell.className = 'align-middle';
                        charCell.rowSpan = pronunciationsArray.length;
                        charCell.innerHTML = `<div class="fs-3 fw-bold text-dark text-center">${word}</div>`;
                        row.appendChild(charCell);
                    }

                    // éŸ³æ ‡å•å…ƒæ ¼
                    const phoneticCell = document.createElement('td');
                    phoneticCell.className = 'align-middle text-center';

                    if (pron.phonetic) {
                        const phonetics = pron.phonetic.split(',');
                        phoneticCell.innerHTML = phonetics.map((ph, phIndex) => {
                            const phoneticClean = ph.trim();
                            return `
                                <span class="phonetic-clickable"
                                      data-phonetic="${phoneticClean}"
                                      onclick="playAudio('${phoneticClean}')">
                                    [${phoneticClean}]
                                    <small class="audio-icon">ğŸ”Š</small>
                                </span>
                                ${phIndex < phonetics.length - 1 ? '<br>' : ''}
                            `;
                        }).join('');
                    } else if (pron.pronunciation) {
                        const phoneticClean = pron.pronunciation.trim();
                        phoneticCell.innerHTML = `
                            <span class="phonetic-clickable"
                                  data-phonetic="${phoneticClean}"
                                  onclick="playAudio('${phoneticClean}')">
                                [${phoneticClean}]
                                <small class="audio-icon">ğŸ”Š</small>
                            </span>
                        `;
                    } else {
                        phoneticCell.innerHTML = '<span class="text-muted">-</span>';
                    }
                    row.appendChild(phoneticCell);

                    // æ³¨é‡Šå•å…ƒæ ¼
                    const notesCell = document.createElement('td');
                    notesCell.className = 'align-middle text-muted text-center';
                    notesCell.textContent = pron.notes ? pron.notes : '-';
                    row.appendChild(notesCell);

                    resultsBody.appendChild(row);
                });
            }
        }
    }
    </script>
</body>
</html>


